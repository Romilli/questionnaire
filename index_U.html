<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>情報観光ルート班 探究アンケート</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 20px;
      background: #f5fff5;
      color: #2d4d2d;
    }
    h1, h2, h3, h4 {
      color: #2f6f3f;
      text-shadow: 1px 1px 0 #cfeccc;
    }
    section {
      margin-bottom: 40px;
      padding: 20px;
      background: #ffffff;
      border: 2px dashed #8fcf8f;
      border-radius: 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.05);
    }
    .hidden { display: none; }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
      background: #fcfffc;
      border-radius: 8px;
      overflow: hidden;
    }
    td, th {
      border: 1px solid #a3d8a3;
      padding: 8px 12px;
    }
    th {
      background: #dff5df;
    }
    input[type="range" min="0" max="3" step="1"] {
      padding: 6px;
      border: 1px solid #88c788;
      border-radius: 6px;
      background: #f9fff9;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background: #6bbb6b;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      transition: 0.15s;
    }
    .btn:hover {
      background: #5aaa5a;
    }
    /* ローディングオーバーレイ */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body>
  <h1>情報観光ルート班 探究アンケート</h1>

  <section id="intro-section">
    <h2>アンケートの目的</h2>
    <p>
      情報観光ルート班では、みなさんが入力した嗜好に沿った富山県の観光ルートを自動生成するアルゴリズムの研究を行っています。<br>
      そこで、本アンケートでは「提示された観光ルートを実際に回りたいと思うか」を評価していただき、
      アルゴリズム改善のためのデータとして活用させていただきます。<br>
      ※回答は研究目的のみで使用し、個人情報は収集しません。回答にかかる目安時間は３〜５分です。ルートは３度生成されるので３度ご確認ください。
      <br><u>あなたの回答で１つの探究が救われます。</u>
    </p>
  </section>

  <!-- 1. 嗜好入力画面 -->
  <section id="pref-section">
    <h2>① 嗜好入力</h2>
    <p>観光に関する10項目の嗜好について、0〜3の4段階で入力してください。</p>
  
    <div id="pref-inputs">
  
      <div class="pref-item">
        <label>自然　　　：</label>
        <select id="pref0">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
      <br>
  
      <div class="pref-item">
        <label>景観　　　：</label>
        <select id="pref1">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
      
      <br>
  
      <div class="pref-item">
        <label>歴史　　　：</label>
        <select id="pref2">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
      
      <br>
      
      <div class="pref-item">
        <label>文化・伝統：</label>
        <select id="pref3">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
      
      <br>
      
      <div class="pref-item">
        <label>芸術　　　：</label>
        <select id="pref4">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
      
      <br>
      
      <div class="pref-item">
        <label>食　　　　：</label>
        <select id="pref5">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
      
      <br>
      
      <div class="pref-item">
        <label>買い物　　：</label>
        <select id="pref6">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
      
      <br>
      
      <div class="pref-item">
        <label>体験　　　：</label>
        <select id="pref7">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
      
      <br>
      
      <div class="pref-item">
        <label>レジャー　：</label>
        <select id="pref8">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
      
      <br>
      
      <div class="pref-item">
        <label>癒し　　　：</label>
        <select id="pref9">
          <option value="-1" selected>選択</option>
          <option value="0">0（興味ない）</option>
          <option value="1">1（少し興味）</option>
          <option value="2">2（興味あり）</option>
          <option value="3">3（とても興味）</option>
        </select>
      </div>
    <br><br>
    </div>
    <button class="btn" onclick="startTrials()">嗜好に沿って観光ルートを生成する</button>
  </section>

  <!-- 2. 試行ごとのタイムテーブル表示 -->
  <section id="trial-section" class="hidden">
    <h2>② 生成したルートの確認（３回行います）</h2>
    <p>嗜好に沿って生成したルートが以下になります。実際に行きたいかの満足度を選択してください。<br>※すべて車での移動を想定しています。始点・終点は店内には入らないため、嗜好に沿った内容ではありません。</p>

    <h3 id="trial-title">生成 1回目</h3>

    <div id="timetable-area">
      <!-- サンプルの固定テーブルを置く -->
      <table>
        <tr><th>地点名</th><th>滞在時間</th><th>到着時間</th><th>出発時間</th></tr>
      </table>
    </div>

    <div style="margin-top:20px;">
      <label>このルートの満足度（1〜5）:
        <select id="score-input">
          <option value="">選択してください</option>
          <option value="1">1（全然回りたくない）</option>
          <option value="2">2（あまり回りたくない）</option>
          <option value="3">3（どちらとも言えない）</option>
          <option value="4">4（少し回ってみたい）</option>
          <option value="5">5（面白そう。回りたい）</option>
        </select>
      </label>
    </div>
    
    <h4 id="trial-title-under">生成 1回目</h4>
    <button class="btn" id="next-btn" onclick="nextTrial()">次へ</button>
  </section>

<script>
  //入力
  const locations = [
  {    name: "富山市ガラス美術館",    address: "富山市西町5番1号",    lat: 36.6884,    lng: 137.215,    rev_val: 4.2,    rev_num: 6126,    open_time: 570,    close_time: 1080,    req_time: 90,    view_pt: [0, 3, 1, 2, 3, 1, 2, 2, 2, 2]  },
  {    name: "国宝高岡山瑞龍寺",    address: "高岡市関本町３５",    lat: 36.7356,    lng: 137.011,    rev_val: 4.4,    rev_num: 3421,    open_time: 540,    close_time: 990,    req_time: 60,    view_pt: [1, 3, 3, 2, 1, 0, 1, 1, 0, 1]  },
  {    name: "富山県富岩運河環水公園",    address: "富山市湊入船町1",    lat: 36.7094,    lng: 137.212,    rev_val: 4.4,    rev_num: 7775,    open_time: 0,    close_time: 1440,    req_time: 45,    view_pt: [2, 3, 0, 2, 1, 0, 0, 2, 2, 2]  },
  {    name: "越中五箇山相倉合掌集落",    address: "南砺市相倉611",    lat: 36.426,    lng: 136.935,    rev_val: 4.3,    rev_num: 3395,    open_time: 510,    close_time: 1020,    req_time: 90,    view_pt: [3, 3, 1, 3, 1, 2, 2, 1, 1, 2]  },
  {    name: "富山県美術館",    address: "富山市木場町3-20",    lat: 36.7106,    lng: 137.21,    rev_val: 4.2,    rev_num: 3015,    open_time: 570,    close_time: 1080,    req_time: 90,    view_pt: [2, 3, 1, 1, 3, 2, 2, 2, 2, 3]  },
  {    name: "日本三大佛高岡大佛",    address: "高岡市大手町11-29",    lat: 36.7456,    lng: 137.017,    rev_val: 4.1,    rev_num: 727,    open_time: 540,    close_time: 1020,    req_time: 60,    view_pt: [1, 2, 3, 3, 2, 0, 0, 1, 1, 2]  },
  {    name: "国定公園雨晴海岸",    address: "高岡市太田雨晴",    lat: 36.8149,    lng: 137.042,    rev_val: 4.4,    rev_num: 2036,    open_time: 0,    close_time: 1440,    req_time: 60,    view_pt: [3, 3, 0, 0, 2, 1, 1, 2, 2, 3]  },
  {    name: "富山城（富山市郷土博物館）",    address: "富山市本丸1-45",    lat: 36.6927,    lng: 137.212,    rev_val: 3.9,    rev_num: 611,    open_time: 540,    close_time: 1020,    req_time: 45,    view_pt: [2, 3, 3, 2, 3, 1, 1, 1, 1, 2]  },
  {    name: "富山市役所展望塔",    address: "富山市新桜町7番38号",    lat: 36.6958,    lng: 137.214,    rev_val: 4.3,    rev_num: 773,    open_time: 540,    close_time: 1080,    req_time: 30,    view_pt: [1, 3, 1, 0, 0, 0, 0, 1, 1, 1]  },
  {    name: "富山市ファミリーパーク",    address: "富山市古沢254番地",    lat: 36.6923,    lng: 137.149,    rev_val: 4.2,    rev_num: 1401,    open_time: 600,    close_time: 930,    req_time: 180,    view_pt: [3, 0, 0, 0, 1, 1, 1, 2, 3, 3]  },
  {    name: "氷見漁港場外市場ひみ番屋街",    address: "氷見市北大町25-5",    lat: 36.8644,    lng: 136.987,    rev_val: 3.9,    rev_num: 6959,    open_time: 510,    close_time: 1200,    req_time: 90,    view_pt: [1, 2, 1, 2, 1, 3, 3, 1, 2, 2]  },
  {    name: "魚津水族館",    address: "魚津市三ケ1390",    lat: 36.7984,    lng: 137.388,    rev_val: 4.1,    rev_num: 1977,    open_time: 540,    close_time: 1020,    req_time: 90,    view_pt: [1, 1, 0, 1, 2, 0, 1, 3, 3, 3]  },
  {    name: "氷見市潮風ギャラリー（藤子不二雄Aアートコレクション）",    address: "氷見市中央町3-4",    lat: 36.8591,    lng: 136.987,    rev_val: 4,    rev_num: 652,    open_time: 0,    close_time: 1440,    req_time: 30,    view_pt: [1, 2, 1, 3, 3, 0, 1, 1, 2, 1]  },
  {    name: "海王丸パーク",    address: "射水市海王町8番地",    lat: 36.7802,    lng: 137.11,    rev_val: 4.4,    rev_num: 65,    open_time: 570,    close_time: 1020,    req_time: 60,    view_pt: [3, 3, 1, 2, 1, 2, 2, 2, 3, 2]  },
  {    name: "ほたるいかミュージアム",    address: "滑川市中川原410",    lat: 36.7741,    lng: 137.344,    rev_val: 3.7,    rev_num: 2639,    open_time: 540,    close_time: 1020,    req_time: 60,    view_pt: [2, 2, 2, 3, 1, 0, 1, 2, 2, 2]  },
  {    name: "ますのすし本舗源ますのすしミュージアム",    address: "富山市南央町37-6",    lat: 36.6277,    lng: 137.205,    rev_val: 3.8,    rev_num: 1554,    open_time: 540,    close_time: 1020,    req_time: 180,    view_pt: [0, 1, 0, 2, 2, 3, 3, 3, 2, 1]  },
  {    name: "新湊大橋",    address: "射水市海王町～海竜町",    lat: 36.7759,    lng: 137.115,    rev_val: 4.4,    rev_num: 386,    open_time: 360,    close_time: 1200,    req_time: 60,    view_pt: [2, 3, 1, 0, 1, 0, 0, 2, 2, 2]  },
  {    name: "池田屋安兵衛商店",    address: "富山市堤町通り1-3-5",    lat: 36.6885,    lng: 137.218,    rev_val: 4.2,    rev_num: 100,    open_time: 540,    close_time: 1080,    req_time: 20,    view_pt: [0, 2, 2, 2, 1, 2, 2, 2, 1, 2]  },
  {    name: "富山ガラス工房",    address: "富山市古沢152",    lat: 36.6953,    lng: 137.146,    rev_val: 4.1,    rev_num: 342,    open_time: 540,    close_time: 1020,    req_time: 30,    view_pt: [1, 1, 0, 2, 3, 0, 2, 3, 3, 2]  },
  {    name: "きときと市場とやマルシェGOSHU",    address: "富山市明輪町1-220",    lat: 36.701,    lng: 137.214,    rev_val: 4.1,    rev_num: 17,    open_time: 540,    close_time: 1230,    req_time: 20,    view_pt: [0, 1, 0, 1, 1, 3, 3, 0, 0, 0]  },
  {    name: "北前船回船問屋森家",    address: "富山市東岩瀬町108",    lat: 36.7568,    lng: 137.229,    rev_val: 3.9,    rev_num: 520,    open_time: 540,    close_time: 1020,    req_time: 30,    view_pt: [1, 2, 3, 3, 2, 0, 1, 2, 1, 2]  },
  {    name: "チューリップ四季彩館",    address: "砺波市中村100番地1",    lat: 36.6411,    lng: 136.965,    rev_val: 4.2,    rev_num: 325,    open_time: 540,    close_time: 1080,    req_time: 60,    view_pt: [2, 3, 0, 2, 2, 1, 2, 2, 2, 3]  },
  {    name: "井波別院瑞泉寺",    address: "南砺市井波305",    lat: 36.5588,    lng: 136.972,    rev_val: 4.3,    rev_num: 724,    open_time: 540,    close_time: 990,    req_time: 30,    view_pt: [2, 3, 3, 2, 2, 0, 1, 2, 1, 3]  },
  {    name: "富山山王さん日枝神社",    address: "富山市山王町4-12",    lat: 36.6866,    lng: 137.214,    rev_val: 4.1,    rev_num: 1001,    open_time: 510,    close_time: 1020,    req_time: 20,    view_pt: [0, 2, 2, 3, 1, 0, 1, 2, 1, 1]  },
  {    name: "富山市科学博物館",    address: "富山市西中野町一丁目8番31号",    lat: 36.6809,    lng: 137.212,    rev_val: 4.2,    rev_num: 791,    open_time: 540,    close_time: 1020,    req_time: 60,    view_pt: [1, 2, 3, 2, 2, 0, 1, 2, 1, 2]  },
  {    name: "富山縣護國神社",    address: "富山市磯部町1-1",    lat: 36.6898,    lng: 137.202,    rev_val: 4.3,    rev_num: 838,    open_time: 510,    close_time: 1020,    req_time: 30,    view_pt: [1, 3, 3, 2, 1, 0, 1, 2, 1, 3]  },
  {    name: "菅沼合掌造り集落",    address: "南砺市菅沼578",    lat: 36.4042,    lng: 136.886,    rev_val: 4.2,    rev_num: 3472,    open_time: 540,    close_time: 1020,    req_time: 45,    view_pt: [3, 3, 1, 2, 2, 2, 2, 2, 2, 3]  },
  {    name: "満天の湯富山店",    address: "富山市石金2丁目1-8",    lat: 36.6871,    lng: 137.233,    rev_val: 4.1,    rev_num: 1842,    open_time: 480,    close_time: 1440,    req_time: 60,    view_pt: [1, 1, 0, 1, 0, 1, 1, 3, 3, 3]  },
  {    name: "高岡おとぎの森公園",    address: "高岡市佐野1342",    lat: 36.7251,    lng: 137,    rev_val: 4.2,    rev_num: 74,    open_time: 540,    close_time: 1020,    req_time: 60,    view_pt: [2, 3, 0, 1, 2, 1, 0, 2, 3, 2]  },
  {    name: "散居村展望台展望広場",    address: "砺波市五谷160",    lat: 36.587,    lng: 137.013,    rev_val: 4.1,    rev_num: 309,    open_time: 0,    close_time: 1440,    req_time: 15,    view_pt: [3, 3, 0, 2, 1, 0, 0, 2, 1, 2]  },
  {    name: "富山県中央植物園",    address: "富山市婦中町上轡田42",    lat: 36.6625,    lng: 137.181,    rev_val: 4.2,    rev_num: 477,    open_time: 540,    close_time: 990,    req_time: 60,    view_pt: [3, 2, 1, 1, 2, 1, 1, 1, 2, 2]  },
  {    name: "秋水美術館",    address: "富山市千石町1-3-6",    lat: 36.6874,    lng: 137.212,    rev_val: 4.2,    rev_num: 262,    open_time: 600,    close_time: 1020,    req_time: 45,    view_pt: [0, 1, 3, 3, 3, 0, 1, 1, 1, 1]  },
  {    name: "日本の名湯金太郎温泉日帰り温泉カルナの館",    address: "魚津市天神野新6000",    lat: 36.8395,    lng: 137.437,    rev_val: 4.1,    rev_num: 648,    open_time: 510,    close_time: 1410,    req_time: 60,    view_pt: [2, 2, 0, 1, 1, 1, 2, 3, 2, 3]  },
  {    name: "諏訪町本通り（富山市八尾町）",    address: "富山市八尾町諏訪町",    lat: 36.5757,    lng: 137.133,    rev_val: 4.2,    rev_num: 267,    open_time: 0,    close_time: 1440,    req_time: 20,    view_pt: [1, 2, 1, 3, 2, 1, 1, 1, 1, 1]  },
  {    name: "富山県立山カルデラ砂防博物館",    address: "中新川郡立山町芦峅寺字ブナ坂68",    lat: 36.5822,    lng: 137.446,    rev_val: 4.3,    rev_num: 398,    open_time: 570,    close_time: 1020,    req_time: 90,    view_pt: [3, 3, 2, 2, 2, 0, 0, 2, 2, 2]  },
  {    name: "富山市郷土博物館",    address: "富山市本丸1-62",    lat: 36.6928,    lng: 137.211,    rev_val: 3.8,    rev_num: 1614,    open_time: 540,    close_time: 1020,    req_time: 30,    view_pt: [2, 2, 2, 3, 2, 0, 0, 1, 1, 1]  },
  {    name: "富山港展望台",    address: "富山市東岩瀬町海岸通り5",    lat: 36.7581,    lng: 137.228,    rev_val: 3.7,    rev_num: 722,    open_time: 540,    close_time: 990,    req_time: 15,    view_pt: [1, 3, 1, 1, 1, 0, 0, 1, 1, 2]  },
  {    name: "高岡古城公園動物園",    address: "高岡市古城1-6",    lat: 36.7478,    lng: 137.023,    rev_val: 4.2,    rev_num: 284,    open_time: 540,    close_time: 990,    req_time: 30,    view_pt: [2, 1, 0, 0, 0, 0, 0, 2, 1, 2]  },
  {    name: "富山市民俗民芸村",    address: "富山市安養坊56-1",    lat: 36.7087,    lng: 137.189,    rev_val: 4,    rev_num: 94,    open_time: 540,    close_time: 1020,    req_time: 80,    view_pt: [2, 2, 2, 3, 2, 0, 0, 1, 1, 1]  },
  {    name: "富山市佐藤記念美術館",    address: "富山市本丸1-62",    lat: 36.6939,    lng: 137.212,    rev_val: 3.9,    rev_num: 71,    open_time: 540,    close_time: 1020,    req_time: 30,    view_pt: [1, 2, 3, 3, 3, 0, 1, 2, 1, 2]  },
  {    name: "高岡市万葉歴史館",    address: "高岡市伏木一宮1-11-11",    lat: 36.7956,    lng: 137.046,    rev_val: 4,    rev_num: 263,    open_time: 540,    close_time: 1020,    req_time: 90,    view_pt: [3, 2, 3, 3, 2, 1, 0, 1, 1, 2]  },
  {    name: "ミラージュランド",    address: "魚津市三ヶ1181-1",    lat: 36.8002,    lng: 137.386,    rev_val: 3.9,    rev_num: 876,    open_time: 600,    close_time: 990,    req_time: 90,    view_pt: [2, 2, 0, 0, 0, 1, 1, 3, 3, 2]  },
  {    name: "県民公園太閤山ランド",    address: "射水市黒河4774-6",    lat: 36.6914,    lng: 137.106,    rev_val: 4.1,    rev_num: 637,    open_time: 540,    close_time: 1020,    req_time: 90,    view_pt: [3, 2, 0, 0, 2, 1, 0, 3, 3, 2]  },
  {    name: "岩瀬の古い町並み",    address: "富山市東岩瀬町",    lat: 36.7565,    lng: 137.229,    rev_val: 4.2,    rev_num: 18,    open_time: 0,    close_time: 1440,    req_time: 120,    view_pt: [2, 3, 2, 3, 1, 3, 2, 2, 1, 2]  },
  {    name: "富山県水墨美術館",    address: "富山市五福777",    lat: 36.6991,    lng: 137.197,    rev_val: 4.1,    rev_num: 750,    open_time: 570,    close_time: 1080,    req_time: 60,    view_pt: [1, 3, 2, 2, 3, 0, 1, 2, 1, 2]  },
  {    name: "営農ワイエムアイ",    address: "富山市中番13番地",    lat: 36.6202,    lng: 137.294,    rev_val: 3.9,    rev_num: 18,    open_time: 480,    close_time: 900,    req_time: 45,    view_pt: [0, 0, 0, 0, 1, 3, 3, 1, 1, 2]  },
  {    name: "桂樹舎・和紙文庫",    address: "富山市八尾町鏡町668-4",    lat: 36.5787,    lng: 137.131,    rev_val: 4.1,    rev_num: 93,    open_time: 600,    close_time: 1020,    req_time: 30,    view_pt: [1, 2, 1, 3, 3, 1, 3, 2, 2, 2]  },
  {    name: "海の駅蜃気楼",    address: "魚津市村木定坊割2500-2",    lat: 36.8249,    lng: 137.394,    rev_val: 3.7,    rev_num: 1653,    open_time: 540,    close_time: 1080,    req_time: 60,    view_pt: [3, 2, 0, 2, 0, 3, 3, 2, 2, 2]  },
  {    name: "真言密教大本山大岩山日石寺",    address: "中新川郡上市町大岩163",    lat: 36.6622,    lng: 137.391,    rev_val: 4.3,    rev_num: 1023,    open_time: 540,    close_time: 960,    req_time: 60,    view_pt: [3, 3, 3, 2, 1, 2, 1, 2, 1, 3]  },
  {    name: "雲龍山勝興寺",    address: "高岡市伏木古国府17番１号",    lat: 36.7926,    lng: 137.052,    rev_val: 4.2,    rev_num: 661,    open_time: 540,    close_time: 960,    req_time: 60,    view_pt: [1, 3, 3, 2, 3, 0, 1, 2, 0, 2]  },
  {    name: "高志の国文学館",    address: "富山市舟橋南町２番２２号",    lat: 36.6955,    lng: 137.206,    rev_val: 4.1,    rev_num: 355,    open_time: 570,    close_time: 1080,    req_time: 60,    view_pt: [1, 3, 3, 2, 3, 1, 1, 1, 1, 2]  },
  {    name: "特別天然記念物魚津埋没林博物館",    address: "魚津市釈迦堂814",    lat: 36.8225,    lng: 137.395,    rev_val: 3.9,    rev_num: 1013,    open_time: 540,    close_time: 1020,    req_time: 60,    view_pt: [2, 3, 2, 2, 0, 0, 1, 2, 2, 2]  },
  {    name: "射水市大島絵本館",    address: "射水市鳥取50",    lat: 36.7342,    lng: 137.074,    rev_val: 4.1,    rev_num: 196,    open_time: 570,    close_time: 1050,    req_time: 60,    view_pt: [1, 2, 0, 2, 3, 0, 0, 2, 1, 2]  },
  {    name: "富山県立イタイイタイ病資料館",    address: "富山市友杉151（とやま健康パーク内）",    lat: 36.6362,    lng: 137.202,    rev_val: 4.3,    rev_num: 170,    open_time: 540,    close_time: 1020,    req_time: 60,    view_pt: [0, 1, 3, 2, 0, 0, 0, 0, 1, 1]  },
  {    name: "氷見あいやまガーデン",    address: "氷見市稲積112番1",    lat: 36.8889,    lng: 136.964,    rev_val: 3.9,    rev_num: 182,    open_time: 540,    close_time: 1020,    req_time: 120,    view_pt: [3, 2, 0, 0, 2, 1, 1, 2, 3, 3]  },
  {    name: "牛岳温泉スキー場",    address: "山田小谷山田中根",    lat: 36.5725,    lng: 137.056,    rev_val: 4.1,    rev_num: 249,    open_time: 510,    close_time: 990,    req_time: 120,    view_pt: [3, 2, 0, 0, 0, 1, 0, 3, 3, 2]  },
  {    name: "梅かまミュージアムU-mei館",    address: "富山市水橋肘崎482-8(カイナザキ)",    lat: 36.7312,    lng: 137.291,    rev_val: 3.5,    rev_num: 40,    open_time: 600,    close_time: 960,    req_time: 60,    view_pt: [0, 0, 1, 3, 2, 3, 2, 3, 2, 2]  },
  {    name: "ミュゼふくおかカメラ館",    address: "高岡市福岡町福岡新559番地",    lat: 36.7115,    lng: 136.93,    rev_val: 4.1,    rev_num: 317,    open_time: 540,    close_time: 1020,    req_time: 60,    view_pt: [0, 2, 1, 2, 3, 1, 1, 1, 1, 2]  },
  {    name: "呉羽山公園展望台",    address: "富山市安養坊",    lat: 36.7089,    lng: 137.185,    rev_val: 4.1,    rev_num: 34,    open_time: 0,    close_time: 1440,    req_time: 30,    view_pt: [3, 2, 1, 0, 2, 0, 0, 1, 2, 2]  },
  {    name: "高岡御車山会館",    address: "高岡市守山町47-1",    lat: 36.7467,    lng: 137.01,    rev_val: 4,    rev_num: 334,    open_time: 540,    close_time: 1020,    req_time: 60,    view_pt: [1, 2, 1, 3, 3, 1, 1, 1, 1, 2]  },
  {    name: "氷見市海浜植物園シーサイドパーク",    address: "氷見市柳田3583",    lat: 36.8373,    lng: 137.005,    rev_val: 3.8,    rev_num: 569,    open_time: 540,    close_time: 1020,    req_time: 90,    view_pt: [3, 2, 0, 0, 1, 1, 1, 2, 2, 3]  },
  {    name: "高岡古城公園（高岡城跡）",    address: "高岡市古城1-1",    lat: 36.7493,    lng: 137.021,    rev_val: 3.9,    rev_num: 565,    open_time: 480,    close_time: 1020,    req_time: 30,    view_pt: [2, 2, 3, 1, 1, 0, 0, 1, 1, 2]  },
  {    name: "まんがロード（氷見市）",    address: "氷見市伊勢大町～北大町",    lat: 36.8597,    lng: 136.987,    rev_val: 3.8,    rev_num: 267,    open_time: 0,    close_time: 1440,    req_time: 90,    view_pt: [1, 1, 1, 3, 3, 0, 0, 1, 2, 1]  },
  {    name: "黒部川電気記念館",    address: "黒部市黒部峡谷口11",    lat: 36.8149,    lng: 137.586,    rev_val: 3.8,    rev_num: 124,    open_time: 540,    close_time: 960,    req_time: 30,    view_pt: [2, 2, 1, 2, 1, 0, 0, 1, 1, 1]  },
  {    name: "高岡市美術館",    address: "高岡市中川1-1-30",    lat: 36.7512,    lng: 137.027,    rev_val: 3.9,    rev_num: 763,    open_time: 570,    close_time: 1020,    req_time: 60,    view_pt: [2, 2, 3, 3, 3, 0, 1, 1, 1, 2]  },
  {    name: "二上山公園(城山園地）",    address: "高岡市東海老坂字馬鞍2056",    lat: 36.79,    lng: 137.015,    rev_val: 4,    rev_num: 41,    open_time: 0,    close_time: 1440,    req_time: 45,    view_pt: [3, 3, 2, 1, 1, 0, 0, 1, 2, 2]  }
  ];
  const routes_cost = [
[0, 2290, 542, 3811, 626, 2445, 2769, 201, 269, 1020, 3384, 2347, 3198, 1928, 2041, 1017, 2003, 53, 1019, 397, 1126, 2074, 2681, 90, 231, 236, 3482, 304, 2104, 2897, 753, 166, 2398, 1759, 2785, 201, 1094, 2335, 725, 213, 2658, 2337, 1567, 1119, 564, 1263, 1682, 2464, 1928, 2606, 383, 2484, 1907, 972, 3532, 2374, 1276, 2711, 772, 2346, 2941, 2484, 3211, 3354, 2209, 2857],
[2228, 0, 2404, 3241, 2355, 411, 1487, 2368, 2329, 1484, 1968, 3209, 1782, 1511, 3006, 2032, 1551, 2281, 1532, 2436, 2467, 1352, 2174, 2228, 2067, 2193, 2912, 2392, 445, 2266, 2205, 2311, 3311, 2503, 3876, 2368, 2435, 459, 2133, 2273, 1375, 3200, 1372, 2460, 2249, 2460, 2449, 3377, 2861, 1324, 2311, 3397, 1013, 1988, 1875, 2584, 2832, 1225, 1986, 459, 1525, 554, 1796, 4267, 503, 1441],
[577, 2313, 0, 4099, 40, 2073, 2397, 509, 471, 978, 3012, 2061, 2826, 1479, 1769, 1324, 1554, 508, 934, 270, 641, 2412, 2939, 646, 716, 443, 3771, 648, 2228, 2932, 836, 616, 2511, 1841, 3113, 509, 609, 1963, 446, 579, 2286, 2052, 1535, 633, 318, 1591, 1765, 2355, 2111, 2234, 387, 2375, 1587, 1261, 3160, 2408, 1074, 2879, 570, 1974, 2569, 2112, 2839, 3383, 1837, 2485],
[3846, 3197, 4269, 0, 4212, 3284, 3596, 3879, 3947, 3212, 3738, 4827, 3666, 3813, 4624, 3650, 3813, 3899, 3245, 4075, 4543, 2408, 1894, 3846, 3685, 3921, 858, 4010, 3014, 2783, 3838, 3829, 4929, 4000, 5494, 3879, 4511, 3332, 3935, 3890, 3611, 4817, 3122, 4536, 3977, 4078, 3928, 4995, 4479, 3559, 3997, 5015, 3283, 3605, 3569, 3809, 4461, 2611, 3788, 3159, 3544, 3426, 3662, 5885, 3376, 3460],
[670, 2371, 52, 4158, 0, 2131, 2455, 567, 529, 1036, 3070, 2076, 2884, 1494, 1785, 1382, 1569, 590, 992, 328, 656, 2470, 2997, 739, 774, 501, 3829, 730, 2286, 2990, 894, 675, 2526, 1899, 3147, 567, 624, 2022, 505, 637, 2344, 2067, 1593, 649, 376, 1673, 1823, 2370, 2126, 2292, 446, 2390, 1646, 1319, 3218, 2467, 1090, 2937, 629, 2033, 2627, 2170, 2898, 3398, 1895, 2543],
[2432, 418, 2126, 3289, 2077, 0, 1147, 2289, 2361, 1580, 1716, 3305, 1530, 1260, 3102, 2129, 1260, 2485, 1628, 2242, 2189, 1539, 2241, 2325, 2163, 2236, 2960, 2648, 581, 2332, 2301, 2416, 3408, 2600, 3973, 2289, 2157, 212, 1927, 2359, 1036, 3296, 1469, 2182, 2097, 2556, 2545, 3473, 2957, 984, 2232, 3493, 924, 2084, 1745, 2651, 2554, 1272, 1854, 218, 1273, 235, 1544, 4364, 256, 1189],
[2740, 1446, 2433, 3598, 2385, 1197, 0, 2596, 2668, 2018, 861, 3848, 756, 1061, 3422, 2739, 1101, 2792, 1999, 2549, 2274, 2218, 2789, 2814, 2793, 2543, 3269, 2955, 1542, 3112, 2739, 2723, 4018, 3104, 4584, 2596, 2242, 1087, 2234, 2667, 331, 3838, 2044, 2267, 2404, 3167, 3049, 4141, 3568, 387, 2540, 4161, 1291, 2695, 1171, 3380, 2861, 1657, 2162, 1144, 435, 1236, 753, 4974, 961, 919],
[159, 2371, 509, 3818, 501, 2317, 2641, 0, 127, 935, 3256, 2305, 3069, 1800, 1999, 1024, 1875, 203, 891, 255, 1077, 2081, 2688, 218, 238, 199, 3490, 406, 2185, 2817, 674, 170, 2427, 1679, 2871, 0, 1045, 2207, 597, 71, 2530, 2296, 1492, 1069, 435, 1349, 1603, 2599, 2030, 2478, 221, 2619, 1778, 979, 3404, 2293, 1234, 2894, 643, 2218, 2813, 2356, 3083, 3383, 2080, 2728],
[277, 2422, 408, 3943, 478, 2439, 2763, 192, 0, 1100, 3378, 2249, 3192, 1903, 1957, 1149, 1979, 286, 1056, 255, 1010, 2206, 2813, 346, 363, 390, 3615, 501, 2236, 2982, 839, 320, 2699, 1844, 2962, 192, 978, 2330, 607, 295, 2652, 2240, 1657, 1003, 479, 1440, 1768, 2542, 2093, 2600, 232, 2562, 1943, 1104, 3526, 2458, 1262, 2843, 731, 2341, 2935, 2478, 3206, 3507, 2203, 2851],
[882, 1562, 1040, 3145, 983, 1656, 2116, 867, 939, 0, 2731, 2286, 2545, 1349, 2083, 1159, 1424, 935, 52, 936, 1398, 1407, 2015, 900, 758, 692, 2816, 1137, 1375, 2207, 704, 810, 2389, 1416, 2954, 867, 1366, 1676, 740, 936, 2005, 2277, 682, 1391, 748, 1537, 1361, 2454, 1938, 1953, 810, 2474, 1127, 1062, 2879, 1684, 1763, 2085, 618, 1693, 2288, 1798, 2558, 3345, 1555, 2204],
[3381, 1910, 3075, 3736, 3026, 1789, 835, 3238, 3310, 2659, 0, 4489, 164, 1895, 4197, 3381, 1936, 3434, 2641, 3190, 3138, 2354, 2927, 3456, 3434, 3185, 3408, 3596, 1787, 3431, 3380, 3364, 4660, 3745, 5225, 3238, 3106, 1679, 2876, 3308, 1166, 4480, 2686, 3131, 3046, 3808, 3690, 4783, 4210, 1222, 3181, 4803, 1933, 3336, 492, 4021, 3502, 1903, 2803, 1561, 392, 1828, 150, 5616, 1578, 1476],
[2312, 3246, 2020, 4767, 2075, 3340, 3906, 2327, 2337, 2241, 4521, 0, 4334, 2914, 411, 2141, 2989, 2260, 2273, 2332, 1677, 3030, 3637, 2410, 2176, 2365, 4439, 2175, 3060, 3949, 2304, 2320, 878, 3124, 3002, 2327, 1622, 3472, 2447, 2348, 3795, 184, 2569, 1692, 2318, 2000, 3047, 418, 1645, 3743, 2416, 438, 2796, 2097, 4669, 3426, 1272, 3667, 2406, 3483, 4078, 3483, 4348, 2116, 3345, 3993],
[3243, 1772, 2937, 3672, 2888, 1651, 719, 3100, 3172, 2521, 186, 4351, 0, 1780, 4059, 3243, 1820, 3296, 2503, 3052, 3000, 2290, 2863, 3318, 3296, 3047, 3343, 3458, 1723, 3367, 3242, 3226, 4522, 3607, 5087, 3100, 2968, 1541, 2738, 3170, 1051, 4342, 2548, 2993, 2908, 3670, 3552, 4645, 4072, 1107, 3043, 4665, 1795, 3198, 494, 3883, 3364, 1871, 2665, 1423, 276, 1690, 14, 5478, 1440, 1338],
[1974, 1578, 1488, 3775, 1568, 1337, 1097, 1830, 1880, 1333, 1958, 2920, 1854, 0, 2524, 2121, 234, 1994, 1298, 1732, 1376, 2037, 2645, 2048, 2068, 1777, 3446, 2135, 1682, 2966, 2086, 1957, 3477, 2482, 3965, 1830, 1344, 1227, 1405, 1900, 1145, 2911, 1423, 1368, 1568, 2548, 2427, 3214, 2950, 1015, 1799, 3234, 852, 2076, 2269, 2774, 1926, 2143, 1345, 1238, 1533, 1376, 1850, 4349, 1101, 1749],
[2054, 3089, 1765, 4610, 1819, 3183, 3497, 2069, 2082, 2083, 4266, 448, 4080, 2558, 0, 1984, 2633, 2002, 2116, 2082, 1321, 2872, 3480, 2152, 2018, 2255, 4281, 1917, 2902, 3792, 2147, 2209, 1202, 2966, 2845, 2069, 1266, 3217, 2192, 2090, 3540, 439, 2412, 1336, 2063, 1843, 2890, 742, 1550, 3414, 2161, 762, 2638, 1939, 4414, 3268, 926, 3510, 2151, 3228, 3823, 3366, 4093, 2440, 3091, 3739],
[1124, 2159, 1455, 3680, 1399, 2253, 2930, 1157, 1225, 1153, 3533, 2186, 3347, 2238, 1983, 0, 2238, 1177, 1186, 1353, 2079, 2028, 2556, 1124, 963, 979, 3351, 1288, 1972, 2529, 778, 1107, 2288, 1117, 2502, 1157, 2047, 2270, 1368, 1169, 2819, 2176, 1482, 2072, 1153, 1019, 1041, 2354, 1838, 2767, 1131, 2374, 1708, 290, 3354, 1849, 1762, 2580, 1414, 2320, 3090, 2395, 3361, 3244, 2229, 3006],
[2062, 1638, 1577, 3772, 1657, 1334, 1157, 1919, 1968, 1422, 2018, 3009, 1914, 245, 2613, 2118, 0, 2083, 1387, 1821, 1465, 2034, 2642, 2137, 2156, 1866, 3443, 2223, 1679, 2963, 2175, 2046, 3566, 2524, 3962, 1919, 1433, 1225, 1494, 1989, 1205, 3000, 1464, 1457, 1657, 2545, 2470, 3303, 2947, 1075, 1888, 3323, 849, 2073, 2329, 2771, 2015, 2140, 1434, 1236, 1593, 1373, 1910, 4353, 1098, 1746],
[51, 2341, 506, 3863, 591, 2496, 2820, 230, 308, 1071, 3435, 2316, 3249, 1962, 2010, 1068, 2037, 0, 1071, 402, 1074, 2125, 2733, 136, 282, 287, 3534, 251, 2155, 2949, 805, 217, 2346, 1810, 2722, 230, 1041, 2387, 754, 251, 2709, 2307, 1618, 1066, 615, 1200, 1734, 2411, 1875, 2657, 434, 2431, 1958, 1023, 3583, 2425, 1245, 2762, 823, 2398, 2992, 2535, 3263, 3302, 2260, 2908],
[1021, 1552, 1123, 3158, 1067, 1646, 2075, 1000, 1072, 44, 2690, 2300, 2504, 1308, 2097, 1123, 1383, 1074, 0, 1069, 1357, 1421, 2028, 1039, 897, 831, 2830, 1276, 1366, 2226, 843, 949, 2402, 1426, 2967, 1000, 1325, 1635, 713, 1071, 1964, 2290, 673, 1350, 868, 1550, 1372, 2468, 1952, 1912, 943, 2488, 1123, 1078, 2838, 1702, 1722, 2075, 566, 1652, 2247, 1783, 2517, 3358, 1515, 2163],
[380, 2474, 334, 4039, 288, 2249, 2573, 287, 207, 1038, 3188, 2298, 3002, 1722, 2006, 1244, 1797, 406, 994, 0, 948, 2301, 2947, 439, 458, 397, 3710, 554, 2288, 2940, 797, 416, 2748, 1803, 3019, 287, 916, 2140, 507, 364, 2462, 2289, 1595, 941, 379, 1497, 1726, 2592, 2142, 2410, 274, 2612, 1764, 1200, 3336, 2417, 1311, 2997, 631, 2150, 2745, 2288, 3016, 3603, 2013, 2661],
[1187, 2545, 647, 4507, 701, 2305, 2379, 1203, 1157, 1449, 3244, 1696, 3058, 1440, 1300, 2018, 1515, 1136, 1414, 964, 0, 2770, 3377, 1272, 1395, 1137, 4179, 1276, 2555, 3575, 1547, 1310, 2446, 2552, 3227, 1203, 115, 2196, 1158, 1233, 2426, 1687, 1862, 15, 1029, 1943, 2476, 1990, 2205, 2296, 1082, 2010, 1820, 1955, 3392, 3051, 900, 3111, 1129, 2206, 2801, 2344, 3072, 3385, 2069, 2717],
[2056, 1283, 2493, 2374, 2437, 1481, 2274, 2089, 2157, 1422, 2380, 3036, 2307, 2023, 2833, 1971, 2023, 2108, 1454, 2379, 2753, 0, 979, 2056, 1894, 2136, 2045, 2220, 1112, 1319, 1788, 2039, 3139, 1811, 3704, 2089, 2721, 1529, 2180, 2100, 2163, 3027, 1332, 2746, 2195, 2287, 1756, 3204, 2689, 2111, 2250, 3224, 1493, 1815, 2211, 1803, 2671, 1044, 1998, 1408, 2186, 1623, 2304, 4095, 1563, 2102],
[2632, 2064, 3093, 1884, 3036, 2194, 2815, 2665, 2733, 1998, 2956, 3613, 2884, 2599, 3409, 2436, 2599, 2684, 2030, 2861, 3329, 988, 0, 2632, 2470, 2735, 2022, 2796, 2014, 1085, 2387, 2615, 3715, 2344, 4280, 2665, 3297, 2242, 2780, 2676, 2830, 3603, 1908, 3322, 2794, 2863, 2273, 3781, 3265, 2778, 2850, 3801, 2069, 2391, 2788, 2154, 3247, 1945, 2574, 2309, 2763, 2337, 2881, 4671, 2276, 2679],
[122, 2257, 641, 3778, 667, 2351, 2828, 236, 304, 987, 3443, 2284, 3257, 1987, 2140, 983, 2063, 175, 1031, 431, 1217, 2040, 2648, 0, 197, 295, 3449, 426, 2071, 2864, 720, 186, 2386, 1725, 2850, 236, 1185, 2394, 796, 247, 2717, 2275, 1534, 1210, 623, 1328, 1649, 2452, 2050, 2665, 439, 2472, 1807, 939, 3591, 2340, 1375, 2678, 831, 2405, 3000, 2543, 3270, 3342, 2268, 2916],
[316, 2149, 783, 3671, 770, 2243, 2908, 358, 426, 879, 3523, 2176, 3337, 2076, 1973, 876, 2152, 330, 923, 554, 1351, 1933, 2541, 321, 0, 388, 3342, 553, 1963, 2757, 613, 308, 2279, 1618, 2730, 358, 1319, 2261, 874, 369, 2797, 2167, 1426, 1344, 658, 1208, 1542, 2344, 1829, 2745, 534, 2364, 1699, 831, 3345, 2233, 1538, 2570, 920, 2311, 3080, 2386, 3351, 3235, 2220, 2996],
[247, 2265, 494, 3880, 437, 2257, 2581, 250, 323, 838, 3196, 2353, 3009, 1740, 2247, 937, 1815, 300, 831, 392, 1097, 2195, 2722, 318, 338, 0, 3552, 551, 2079, 2716, 572, 224, 2455, 1577, 2979, 250, 1065, 2147, 537, 314, 2470, 2343, 1385, 1090, 376, 1457, 1501, 2521, 2175, 2418, 194, 2541, 1718, 874, 3344, 2192, 1483, 2788, 583, 2158, 2753, 2296, 3023, 3411, 2020, 2668],
[3473, 2825, 3896, 839, 3840, 2911, 3224, 3507, 3575, 2840, 3365, 4454, 3293, 3441, 4251, 3278, 3440, 3526, 2872, 3702, 4171, 2035, 1994, 3474, 3312, 3549, 0, 3637, 2642, 3112, 3465, 3457, 4557, 3725, 5122, 3507, 4139, 2960, 3562, 3518, 3239, 4445, 2750, 4164, 3605, 3705, 3671, 4622, 4106, 3187, 3624, 4642, 2911, 3233, 3197, 3687, 4089, 2239, 3415, 2786, 3172, 3054, 3290, 5513, 3004, 3087],
[319, 2494, 661, 4015, 747, 2681, 3005, 487, 565, 1319, 3620, 2079, 3433, 2117, 1928, 1220, 2193, 268, 1338, 596, 1229, 2277, 2885, 404, 512, 554, 3686, 0, 2308, 3197, 1053, 485, 2182, 2058, 2539, 487, 1197, 2571, 948, 508, 2894, 2070, 1866, 1222, 821, 1122, 1982, 2247, 1711, 2842, 679, 2267, 2043, 1176, 3768, 2673, 1170, 2915, 1072, 2582, 3177, 2720, 3447, 3138, 2444, 3092],
[2067, 455, 2382, 3006, 2326, 599, 1564, 2207, 2168, 1323, 1837, 3048, 1808, 1655, 2845, 1871, 1655, 2120, 1371, 2276, 2512, 1143, 2041, 2067, 1906, 2032, 2677, 2231, 0, 2154, 2044, 2150, 3150, 2343, 3716, 2207, 2480, 647, 1972, 2112, 1453, 3039, 1211, 2505, 2088, 2299, 2288, 3216, 2700, 1401, 2150, 3236, 1049, 1827, 1669, 2445, 2683, 997, 1825, 471, 1551, 741, 1821, 4106, 691, 1467],
[2823, 2185, 2990, 2773, 2934, 2315, 3108, 2803, 2876, 2130, 3406, 3926, 3334, 2940, 3723, 2424, 2940, 2875, 2162, 2876, 3461, 1279, 1024, 2840, 2698, 2632, 3072, 3078, 2073, 0, 2284, 2750, 4029, 1975, 4621, 2803, 3429, 2364, 2677, 2874, 2997, 3917, 2222, 3454, 2692, 3185, 1904, 4094, 3578, 2945, 2747, 4114, 2319, 2416, 3238, 1785, 3561, 2268, 2699, 2439, 3213, 2458, 3331, 4985, 2398, 3129],
[735, 2188, 890, 3724, 834, 2282, 2791, 718, 790, 762, 3406, 2310, 3219, 2006, 2107, 748, 2081, 788, 806, 786, 1515, 1792, 2319, 752, 610, 545, 3395, 990, 2002, 2313, 0, 662, 2412, 1230, 2992, 718, 1483, 2313, 803, 788, 2680, 2300, 1309, 1507, 588, 1510, 1154, 2478, 1962, 2628, 661, 2498, 1754, 740, 3384, 1789, 1879, 2700, 850, 2368, 2963, 2425, 3233, 3368, 2230, 2878],
[151, 2206, 639, 3727, 615, 2300, 2776, 184, 252, 936, 3391, 2233, 3205, 1935, 2128, 933, 2011, 203, 980, 379, 1206, 1990, 2597, 157, 147, 243, 3398, 454, 2020, 2813, 669, 0, 2335, 1675, 2801, 184, 1174, 2342, 744, 195, 2665, 2224, 1483, 1199, 571, 1280, 1598, 2401, 1885, 2613, 387, 2421, 1756, 888, 3539, 2290, 1364, 2627, 779, 2353, 2948, 2491, 3219, 3291, 2216, 2864],
[2469, 3378, 2515, 4899, 2570, 3472, 4149, 2502, 2570, 2373, 4753, 909, 4566, 3513, 1209, 2273, 3588, 2447, 2405, 2827, 2448, 3162, 3769, 2469, 2307, 2496, 4570, 2268, 3192, 4081, 2436, 2452, 0, 3256, 3134, 2502, 2393, 3489, 2941, 2513, 4038, 921, 2701, 2463, 2813, 2132, 3179, 777, 2074, 3986, 2648, 815, 2928, 2228, 4573, 3558, 1844, 3799, 2900, 3539, 4310, 3615, 4580, 1663, 3448, 4225],
[1717, 2523, 1873, 3959, 1816, 2617, 3186, 1700, 1772, 1380, 3800, 3063, 3614, 2480, 2860, 1089, 2517, 1770, 1412, 1769, 2497, 1821, 2281, 1735, 1593, 1527, 3720, 1972, 2337, 2001, 1195, 1644, 3166, 0, 3065, 1700, 2465, 2670, 1786, 1770, 3074, 3054, 1642, 2489, 1570, 1709, 150, 3231, 2715, 3022, 1643, 3251, 2143, 1146, 3718, 1061, 2640, 2729, 1832, 2684, 3358, 2760, 3628, 4122, 2629, 3273],
[2729, 3807, 3059, 5328, 3144, 3901, 4578, 2885, 2963, 2801, 5182, 3029, 4995, 3887, 2826, 2444, 3886, 2677, 2834, 2993, 3087, 3590, 4198, 2742, 2671, 2903, 4999, 2507, 3621, 4510, 2984, 2838, 3131, 3063, 0, 2885, 3136, 3918, 3346, 2906, 4467, 3019, 3130, 3079, 3218, 1593, 2987, 3197, 2375, 4415, 3055, 3217, 3356, 2499, 5002, 3857, 2480, 4228, 3444, 3968, 4739, 4044, 5009, 4087, 3877, 4654],
[159, 2371, 509, 3818, 501, 2317, 2641, 0, 127, 935, 3256, 2305, 3069, 1800, 1999, 1024, 1875, 203, 891, 255, 1077, 2081, 2688, 218, 238, 199, 3490, 406, 2185, 2817, 674, 170, 2427, 1679, 2871, 0, 1045, 2207, 597, 71, 2530, 2296, 1492, 1069, 435, 1349, 1603, 2599, 2030, 2478, 221, 2619, 1778, 979, 3404, 2293, 1234, 2894, 643, 2218, 2813, 2356, 3083, 3383, 2080, 2728],
[1125, 2483, 585, 4446, 640, 2244, 2317, 1141, 1095, 1387, 3182, 1663, 2996, 1378, 1267, 1956, 1453, 1074, 1352, 902, 117, 2708, 3316, 1210, 1334, 1075, 4117, 1214, 2494, 3513, 1485, 1249, 2413, 2491, 3246, 1141, 0, 2134, 1096, 1172, 2365, 1654, 1800, 132, 967, 1961, 2414, 1956, 2223, 2235, 1020, 1976, 1758, 1893, 3330, 2990, 919, 3049, 1067, 2145, 2739, 2282, 3010, 3352, 2007, 2655],
[2454, 460, 2112, 3343, 2063, 212, 1119, 2310, 2382, 1602, 1697, 3355, 1510, 1261, 3234, 2178, 1246, 2507, 1615, 2227, 2175, 1481, 2283, 2529, 2212, 2258, 3014, 2634, 641, 2375, 2323, 2437, 3457, 2677, 4022, 2310, 2143, 0, 1913, 2381, 1008, 3345, 1511, 2168, 2083, 2605, 2622, 3523, 3007, 956, 2254, 3543, 804, 2133, 1845, 2693, 2540, 1326, 1876, 382, 1254, 250, 1524, 4413, 136, 1170],
[756, 2151, 561, 3841, 505, 1984, 2308, 612, 607, 715, 2923, 2484, 2736, 1430, 2192, 1337, 1505, 816, 671, 507, 1133, 2219, 2746, 831, 850, 560, 3512, 974, 1965, 2740, 814, 739, 2934, 1819, 3434, 612, 1101, 1874, 0, 683, 2197, 2475, 1272, 1126, 306, 1913, 1743, 2778, 2534, 2145, 527, 2798, 1498, 1253, 3071, 2216, 1498, 2674, 167, 1885, 2480, 2023, 2750, 3806, 1747, 2395],
[367, 2529, 497, 4033, 453, 2414, 2738, 282, 89, 1093, 3353, 2338, 3167, 1878, 2047, 1238, 1953, 376, 1049, 217, 1100, 2295, 2981, 435, 452, 388, 3704, 590, 2343, 2975, 832, 409, 2788, 1837, 3051, 282, 1068, 2304, 581, 0, 2627, 2329, 1650, 1092, 454, 1529, 1761, 2632, 2183, 2575, 224, 2652, 1936, 1193, 3501, 2451, 1352, 3052, 705, 2315, 2910, 2453, 3180, 3597, 2178, 2826],
[2644, 1350, 2338, 3601, 2289, 1101, 344, 2501, 2573, 1922, 1205, 3752, 1100, 1137, 3460, 2644, 1177, 2697, 1904, 2453, 2401, 2122, 2792, 2719, 2697, 2448, 3273, 2859, 1446, 3017, 2643, 2627, 3923, 3008, 4488, 2501, 2369, 992, 2139, 2571, 0, 3743, 1949, 2394, 2309, 3071, 2953, 4046, 3473, 291, 2444, 4066, 1196, 2599, 1515, 3284, 2765, 1661, 2066, 1048, 779, 1140, 1097, 4879, 865, 772],
[2345, 3279, 2054, 4801, 2108, 3374, 3939, 2360, 2370, 2274, 4554, 159, 4368, 2947, 444, 2175, 3022, 2294, 2307, 2366, 1710, 3063, 3671, 2444, 2209, 2398, 4472, 2209, 3093, 3983, 2338, 2354, 902, 3157, 3036, 2360, 1655, 3505, 2480, 2381, 3828, 0, 2603, 1725, 2351, 2033, 3081, 373, 1678, 3776, 2449, 393, 2829, 2130, 4702, 3459, 1306, 3701, 2439, 3516, 4111, 3516, 4381, 2140, 3379, 4027],
[1526, 1412, 1686, 3178, 1629, 1507, 2131, 1510, 1582, 627, 2746, 2667, 2560, 1425, 2464, 1491, 1508, 1579, 674, 1579, 1816, 1440, 2048, 1543, 1401, 1336, 2849, 1781, 1226, 2369, 1348, 1453, 2769, 1731, 3335, 1510, 1784, 1540, 1275, 1579, 2020, 2658, 0, 1808, 1392, 1918, 1676, 2835, 2319, 1968, 1454, 2855, 978, 1446, 2608, 2007, 2180, 1935, 1128, 1574, 2303, 1649, 2573, 3725, 1498, 2219],
[1172, 2530, 632, 4492, 686, 2290, 2364, 1188, 1142, 1434, 3229, 1704, 3043, 1425, 1308, 2003, 1500, 1121, 1399, 949, 7, 2755, 3362, 1257, 1380, 1122, 4164, 1261, 2540, 3560, 1532, 1295, 2454, 2537, 3212, 1188, 123, 2181, 1143, 1218, 2411, 1694, 1847, 0, 1014, 1928, 2461, 1997, 2190, 2281, 1067, 2017, 1805, 1940, 3377, 3036, 885, 3096, 1114, 2192, 2786, 2329, 3057, 3393, 2054, 2702],
[518, 2216, 475, 3832, 419, 2166, 2490, 375, 447, 790, 3105, 2399, 2919, 1633, 2107, 1118, 1708, 571, 740, 475, 1048, 2147, 2674, 593, 612, 322, 3503, 780, 2030, 2667, 595, 502, 2848, 1600, 3206, 375, 1016, 2056, 339, 445, 2379, 2389, 1337, 1040, 0, 1684, 1524, 2692, 2404, 2327, 318, 2712, 1628, 1041, 3253, 2143, 1412, 2739, 493, 2067, 2662, 2205, 2932, 3654, 1930, 2578],
[1206, 2434, 1537, 3955, 1622, 2528, 3205, 1363, 1440, 1428, 3809, 1984, 3622, 2513, 1781, 994, 2513, 1155, 1461, 1471, 1810, 2217, 2825, 1220, 1149, 1381, 3626, 1147, 2248, 3254, 1503, 1316, 2087, 1711, 1599, 1363, 1859, 2545, 1823, 1384, 3094, 1975, 1757, 1803, 1696, 0, 1635, 2152, 1418, 3042, 1533, 2172, 1983, 1018, 3629, 2505, 1203, 2855, 1922, 2595, 3366, 2670, 3636, 3043, 2504, 3281],
[1682, 2488, 1838, 3934, 1781, 2582, 3151, 1665, 1737, 1345, 3766, 3028, 3579, 2445, 2825, 1054, 2482, 1735, 1377, 1734, 2462, 1786, 2255, 1700, 1558, 1492, 3685, 1937, 2302, 1976, 1160, 1609, 3131, 143, 3030, 1665, 2430, 2635, 1751, 1735, 3039, 3019, 1607, 2454, 1535, 1674, 0, 3196, 2680, 2987, 1608, 3216, 2108, 1111, 3684, 1035, 2605, 2694, 1797, 2649, 3323, 2725, 3593, 4087, 2594, 3238],
[2645, 3448, 2354, 4969, 2408, 3542, 4239, 2660, 2670, 2443, 4854, 445, 4668, 3247, 744, 2343, 3322, 2593, 2475, 2666, 2010, 3231, 3839, 2539, 2377, 2566, 4640, 2338, 3262, 4151, 2506, 2522, 747, 3325, 3204, 2660, 1955, 3559, 2780, 2681, 4128, 385, 2771, 2025, 2651, 2202, 3249, 0, 1978, 4076, 2749, 158, 2997, 2298, 4643, 3628, 1606, 3869, 2739, 3609, 4411, 3685, 4681, 2060, 3518, 4327],
[1958, 2909, 2130, 4430, 2184, 3003, 3680, 2109, 2101, 1904, 4284, 1699, 4098, 2989, 1563, 1804, 2989, 1907, 1936, 2193, 2195, 2693, 3300, 2043, 1839, 2028, 4102, 1728, 2723, 3613, 1967, 1984, 1964, 2787, 2405, 2109, 2244, 3021, 2556, 2045, 3569, 1690, 2232, 2187, 2428, 1448, 2711, 1993, 0, 3517, 2179, 2013, 2459, 1760, 4105, 3089, 1528, 3330, 2515, 3070, 3841, 3146, 4111, 2920, 2979, 3757],
[2606, 1312, 2299, 3563, 2251, 1063, 394, 2462, 2534, 1884, 1255, 3713, 1151, 988, 3350, 2605, 1028, 2658, 1865, 2415, 2201, 2084, 2754, 2680, 2659, 2409, 3234, 2821, 1408, 2978, 2605, 2589, 3884, 2969, 4449, 2462, 2169, 953, 2100, 2532, 295, 3704, 1910, 2194, 2270, 3033, 2915, 4007, 3434, 0, 2405, 4027, 1157, 2561, 1566, 3245, 2727, 1622, 2028, 1009, 829, 1102, 1147, 4840, 826, 888],
[395, 2340, 388, 3951, 332, 2286, 2610, 225, 220, 904, 3225, 2412, 3038, 1758, 2120, 1079, 1833, 448, 860, 287, 992, 2266, 2793, 453, 472, 199, 3622, 631, 2154, 2786, 643, 356, 2598, 1648, 3122, 225, 960, 2176, 461, 296, 2499, 2403, 1461, 985, 334, 1600, 1572, 2706, 2255, 2447, 0, 2726, 1748, 1017, 3373, 2262, 1426, 2863, 585, 2187, 2782, 2325, 3052, 3554, 2049, 2698],
[2604, 3407, 2312, 4928, 2367, 3501, 4198, 2619, 2629, 2401, 4813, 404, 4627, 3206, 703, 2302, 3281, 2552, 2434, 2625, 1969, 3190, 3798, 2498, 2336, 2525, 4599, 2297, 3220, 4110, 2465, 2481, 796, 3284, 3163, 2619, 1914, 3518, 2739, 2640, 4087, 344, 2730, 1984, 2610, 2161, 3208, 182, 1937, 4035, 2708, 0, 2956, 2257, 4602, 3586, 1564, 3828, 2698, 3568, 4370, 3643, 4640, 2019, 3477, 4286],
[1946, 1081, 1740, 3283, 1692, 914, 1393, 1802, 1874, 1087, 2008, 2805, 1822, 861, 2602, 1629, 861, 1999, 1106, 1871, 1804, 1545, 2153, 1825, 1663, 1749, 2954, 1988, 1065, 2399, 1808, 1929, 2908, 2100, 3473, 1802, 1772, 805, 1515, 1873, 1282, 2796, 975, 1796, 1670, 2056, 2045, 2973, 2457, 1230, 1746, 2993, 0, 1584, 2156, 2282, 2168, 1775, 1368, 971, 1565, 953, 1836, 3864, 763, 1481],
[1020, 2055, 1307, 3576, 1250, 2149, 2826, 1053, 1121, 1049, 3429, 2082, 3243, 2134, 1879, 201, 2134, 1073, 1082, 1249, 1910, 1966, 2493, 1020, 859, 856, 3247, 1184, 1868, 2466, 715, 1003, 2184, 1151, 2478, 1053, 1878, 2166, 1306, 1065, 2715, 2072, 1378, 1903, 1090, 995, 1075, 2250, 1734, 2663, 1007, 2270, 1604, 0, 3250, 1786, 1738, 2476, 1352, 2216, 2986, 2291, 3257, 3140, 2125, 2902],
[3565, 1856, 3258, 3601, 3210, 1829, 1147, 3421, 3493, 2717, 492, 4673, 502, 2208, 4381, 3265, 2248, 3618, 2824, 3374, 3322, 2219, 2792, 3640, 3300, 3368, 3273, 3780, 1652, 3296, 3438, 3548, 4544, 3737, 5109, 3421, 3290, 1863, 3060, 3492, 1479, 4663, 2605, 3314, 3230, 3693, 3682, 4610, 4094, 1535, 3365, 4630, 2117, 3221, 0, 3867, 3686, 1768, 2987, 1592, 704, 1920, 487, 5500, 1761, 1660],
[2337, 2564, 2505, 3774, 2449, 2698, 3445, 2318, 2390, 1645, 3968, 3435, 3862, 2754, 3232, 1812, 2754, 2390, 1677, 2391, 2976, 1849, 2095, 2355, 2213, 2147, 3676, 2592, 2418, 1816, 1799, 2265, 3538, 1066, 3848, 2318, 2944, 2747, 2192, 2389, 3334, 3426, 1907, 2969, 2207, 2493, 994, 3603, 3087, 3282, 2262, 3623, 2224, 1804, 3800, 0, 3070, 2757, 2214, 2765, 3606, 2841, 3876, 4494, 2744, 3521],
[1293, 2840, 1039, 4385, 1093, 2600, 2875, 1308, 1355, 1744, 3539, 1292, 3353, 1936, 895, 1795, 2011, 1241, 1709, 1351, 855, 2647, 3255, 1391, 1491, 1518, 4056, 1166, 2677, 3567, 1855, 1449, 1811, 2741, 2517, 1308, 904, 2491, 1465, 1329, 2813, 1282, 2157, 848, 1337, 1233, 2665, 1585, 1465, 2761, 1434, 1605, 2115, 1820, 3687, 3043, 0, 3406, 1424, 2502, 3096, 2639, 3367, 2714, 2364, 3012],
[2682, 1192, 2999, 2626, 2951, 1278, 1642, 2715, 2783, 2080, 1933, 3663, 1846, 2133, 3460, 2486, 2133, 2735, 2127, 3032, 3063, 1059, 1946, 2682, 2521, 2789, 2297, 2846, 1009, 2348, 2717, 2665, 3765, 2741, 4331, 2715, 3031, 1327, 2728, 2727, 1657, 3654, 1968, 3056, 2845, 2914, 2686, 3831, 3315, 1605, 2907, 3851, 1806, 2442, 1765, 2733, 3427, 0, 2581, 1153, 1589, 1421, 1860, 4721, 1371, 1505],
[820, 1984, 665, 3674, 609, 1900, 2224, 676, 711, 548, 2839, 2410, 2652, 1346, 2118, 1420, 1421, 873, 504, 611, 1059, 1936, 2544, 895, 914, 624, 3345, 1078, 1798, 2761, 897, 803, 2859, 1902, 3480, 676, 1027, 1790, 147, 747, 2113, 2400, 1105, 1051, 410, 1986, 1826, 2703, 2460, 2061, 620, 2723, 1392, 1345, 2987, 2238, 1423, 2507, 0, 1801, 2396, 1939, 2666, 3731, 1663, 2312],
[2390, 348, 2084, 3150, 2035, 318, 1131, 2247, 2319, 1668, 1565, 3498, 1379, 1218, 3206, 2237, 1217, 2443, 1650, 2199, 2147, 1447, 2345, 2465, 2271, 2194, 2821, 2605, 489, 2459, 2389, 2373, 3516, 2754, 4081, 2247, 2115, 366, 1885, 2317, 1020, 3489, 1577, 2140, 2055, 2664, 2699, 3792, 3066, 968, 2190, 3812, 942, 2192, 1594, 2778, 2511, 1133, 1812, 0, 1122, 408, 1393, 4472, 410, 1038],
[2974, 1503, 2667, 3542, 2619, 1381, 434, 2830, 2902, 2252, 416, 4082, 312, 1494, 3790, 2974, 1535, 3027, 2233, 2783, 2731, 2160, 2733, 3049, 3027, 2777, 3213, 3189, 1549, 3237, 2973, 2957, 4252, 3338, 4818, 2830, 2699, 1272, 2469, 2901, 765, 4072, 2279, 2723, 2639, 3401, 3283, 4375, 3802, 821, 2774, 4395, 1525, 2929, 727, 3614, 3095, 1601, 2396, 1154, 0, 1420, 308, 5208, 1170, 1068],
[2524, 587, 2217, 3445, 2169, 339, 1225, 2380, 2452, 1750, 1809, 3475, 1623, 1351, 3339, 2298, 1351, 2576, 1783, 2333, 2280, 1695, 2410, 2598, 2333, 2327, 3116, 2739, 737, 2502, 2471, 2507, 3577, 2769, 4142, 2380, 2248, 262, 2018, 2450, 1114, 3466, 1638, 2273, 2188, 2726, 2715, 3643, 3127, 1062, 2323, 3663, 974, 2254, 1957, 2820, 2645, 1428, 1946, 374, 1366, 0, 1636, 4533, 306, 1282],
[3258, 1787, 2951, 3671, 2903, 1665, 719, 3114, 3186, 2536, 172, 4365, 14, 1780, 4074, 3257, 1820, 3310, 2517, 3067, 3014, 2289, 2862, 3332, 3311, 3061, 3342, 3473, 1722, 3366, 3257, 3241, 4536, 3621, 5101, 3114, 2982, 1555, 2752, 3184, 1051, 4356, 2562, 3007, 2922, 3685, 3567, 4659, 4086, 1107, 3057, 4679, 1809, 3212, 479, 3897, 3379, 1885, 2680, 1437, 276, 1704, 0, 5492, 1454, 1352],
[3408, 4317, 3372, 5839, 3426, 4412, 5089, 3442, 3510, 3312, 5692, 2159, 5506, 4370, 2470, 3213, 4397, 3387, 3345, 3637, 3421, 4101, 4709, 3409, 3247, 3436, 5510, 3208, 4131, 5021, 3376, 3392, 1642, 4195, 4074, 3442, 3367, 4429, 3798, 3453, 4978, 2171, 3641, 3436, 3669, 3071, 4119, 2166, 2942, 4926, 3588, 2204, 3867, 3168, 5513, 4497, 2766, 4739, 3757, 4479, 5249, 4554, 5520, 0, 4388, 5165],
[2284, 485, 1978, 3368, 1929, 236, 985, 2141, 2213, 1543, 1619, 3392, 1433, 1112, 3100, 2120, 1112, 2337, 1556, 2093, 2041, 1506, 2308, 2359, 2154, 2088, 3039, 2500, 666, 2400, 2264, 2268, 3398, 2618, 3964, 2141, 2009, 127, 1779, 2211, 874, 3383, 1466, 2034, 1949, 2547, 2563, 3464, 2948, 822, 2084, 3484, 746, 2075, 1767, 2718, 2406, 1351, 1706, 401, 1176, 275, 1447, 4354, 0, 1092],
[2905, 1434, 2599, 3474, 2550, 1313, 913, 2762, 2834, 2183, 1541, 4013, 1355, 1715, 3721, 2905, 1755, 2958, 2165, 2714, 2662, 2092, 2665, 2980, 2958, 2709, 3145, 3121, 1481, 3168, 2904, 2889, 4184, 3269, 4749, 2762, 2630, 1203, 2400, 2832, 751, 4004, 2210, 2655, 2570, 3332, 3214, 4307, 3734, 881, 2705, 4327, 1457, 2860, 1689, 3545, 3026, 1533, 2327, 1085, 1098, 1352, 1368, 5140, 1102, 0]];
  for(let i=0; i<66; i++) for(let j=0; j<66; j++) routes_cost[i][j] /= 60;
  const CONST_REVIEW_NUM = 384.0;
  // 配列シャッフル用
  function randInt(a, b) { return a + Math.floor(Math.random() * (b - a + 1)); } // [a,b] の整数
  // 時刻を hh:mm 形式に整形するヘルパー
  function formatTime(time) {
    const hour = Math.floor(time / 60);
    const minute = Math.floor(time % 60);
    const hh = hour < 10 ? `0${hour}` : `${hour}`;
    const mm = minute < 10 ? `0${minute}` : `${minute}`;
    return `${hh}:${mm}`;
  }
  
  
  let pref = [];
  let scores = [];
  let trialIndex = 0;
  const P = {
    N: locations.length,
    start_vertex: 19, // 例: locations[0]をスタート
    goal_vertex: 19, // 例: 最後をゴール
    start_time: 540.0, // 例: 9:00
    goal_time: 1200.0, // 例: 20:00
    prefers: [3, 3, 0, 0, 2, 3, 1, 0, 1, 3], // ユーザー嗜好
    review_val: locations.map(l => l.rev_val),
    review_num: locations.map(l => l.rev_num),
    open_time: locations.map(l => [l.open_time, l.close_time]),
    required_time: locations.map(l => l.req_time),
    view_points: locations.map(l => l.view_pt),
    pos_lats: locations.map(l => l.lat),
    pos_lngs: locations.map(l => l.lng),
    pos_names: locations.map(l => [l.name, l.address]),
    cost: routes_cost,
  };
  
//-----------フロントエンド------------------------------------------------
  async function startTrials() {
    pref = [
      Number(document.getElementById('pref0').value),
      Number(document.getElementById('pref1').value),
      Number(document.getElementById('pref2').value),
      Number(document.getElementById('pref3').value),
      Number(document.getElementById('pref4').value),
      Number(document.getElementById('pref5').value),
      Number(document.getElementById('pref6').value),
      Number(document.getElementById('pref7').value),
      Number(document.getElementById('pref8').value),
      Number(document.getElementById('pref9').value)
    ];
    
    if (pref.some(v => v === -1)) {
      alert('すべての項目を選択してください');
      return;
    }
  
    document.getElementById('pref-section').classList.add('hidden');
    document.getElementById('trial-section').classList.remove('hidden');
    
    trialIndex++; // 1になる
    
    showLoading();
  
    // ★ computeRoute を裏で即開始（1秒の計算）
    const promiseCompute = computeRoute();

    // ★ ローディングは最低 1秒表示
    await new Promise(resolve => setTimeout(resolve, 1000));

    // ★ computeRoute が終わるまで待つ
    const newRoute = await promiseCompute;

    hideLoading();
    updateTrialTitle();

    // ★ テーブル更新
    const tableData = makeTimeTable(P, newRoute)
    renderTimeTable(tableData);
    
    updateTrialTitle();
  }

  async function nextTrial() {
    const score = Number(document.getElementById('score-input').value);
    if (score < 1 || score > 5) {
      alert('1〜5 の評価を入力してください');
      return;
    }
  
    scores.push(score);
    document.getElementById('score-input').value = '';
    
    // 上に戻す
    window.scrollTo({ top: 0, behavior: "smooth" });
  
    trialIndex++;
  
    if (trialIndex <= 3 ) {
      showLoading();
  
      // ★ computeRoute を裏で即開始（1秒の計算）
      const promiseCompute = computeRoute();
  
      // ★ ローディングは最低 1秒表示
      await new Promise(resolve => setTimeout(resolve, 2000));
  
      // ★ computeRoute が終わるまで待つ
      const newRoute = await promiseCompute;
  
      hideLoading();
      updateTrialTitle();
  
      // ★ テーブル更新
      const tableData = makeTimeTable(P, newRoute)
      renderTimeTable(tableData);
  
    } else {
      goToGoogleForm();
    }
  }

  //時間割関係
  function renderTimeTable(tableData) {
    const tableArea = document.getElementById("timetable-area");
  
    let html = "<table border='1'><tr><th>地点名</th><th>滞在時間</th><th>到着時間</th><th>出発時間</th></tr>";
  
    tableData.forEach((row, index) => {
      // 奇数行（0,1,2,... の index で index % 2 === 1）を薄黄色に
      const bgColor = (index % 2 === 0) ? "background-color:#fff9c4;" : "";
      html += `<tr style="${bgColor}">`;
      row.forEach(cell => {
        html += `<td>${cell}</td>`;
      });
      html += "</tr>";
    });
  
    html += "</table>";
  
    tableArea.innerHTML = html;
  }
  function makeTimeTable(P, route) {
    
    const route_num = route.length;
    const table = Array.from({ length: route_num * 2 - 1 }, () => Array(4).fill(''));
    let now_time = P.start_time;
  
    // 出発地点
    table[0][0] = P.pos_names[route[0]][0];
    table[0][1] = "出発";
    table[0][3] = formatTime(now_time);
  
    for (let i = 1; i < route_num - 1; i++) {
      let k = i * 2 - 1;
      const prev = route[i - 1];
      const cur = route[i];
  
      // 移動行
      table[k][0] = "↓";
      table[k][1] = `${Math.floor(P.cost[prev][cur])}分`;
  
      now_time += P.cost[prev][cur];
  
      const open_s = P.open_time[cur][0];
      if (now_time < open_s) {
        table[k][1] += `(+待ち${Math.floor(open_s - now_time)}分)`;
        now_time = open_s;
      }
  
      // 観光行
      k = i * 2;
      table[k][0] = P.pos_names[cur][0];
      table[k][1] = `${Math.floor(P.required_time[cur])}分`;
  
      table[k][2] = formatTime(now_time);
      now_time += P.required_time[cur];
      table[k][3] = formatTime(now_time);
    }

  // ゴール
  const tmp = route_num - 1;
  let k = tmp * 2 - 1;
  table[k][0] = "↓";
  table[k][1] = `${Math.floor(P.cost[route[tmp - 1]][route[tmp]])}分`;

  k = tmp * 2;
  now_time += P.cost[route[tmp - 1]][route[tmp]];
  table[k][0] = P.pos_names[route[tmp]][0];
  table[k][1] = "到着";
  table[k][2] = formatTime(now_time);

  return table;
}

  function updateTrialTitle() {
    document.getElementById('trial-title').textContent = `生成 ${trialIndex}回目`;
    document.getElementById('trial-title-under').textContent = `生成 ${trialIndex}回目`;
    const nextBtn = document.getElementById('next-btn');
    if (trialIndex === 3) {
      nextBtn.textContent = '回答結果を送信';
    } else {
      nextBtn.textContent = '次へ';
    }
  }

  function finishTrials() {
    document.getElementById('trial-section').classList.add('hidden');
    document.getElementById('final-section').classList.remove('hidden');
  }

  function goToGoogleForm() {
    // Google Form の URL（仮）
    const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSdDM0hjOZnjpKQj89FsSBtHxndqi3cdssM-6nnap0wnlG8Okw/viewform';

    // 例：4つの評価値を query parameter として埋め込む
    // 実際には Google Form 側の entry ID に合わせて修正してください
    const url = `${formUrl}?usp=pp_url&entry.1630922652=${pref.join(' ')}&entry.627106255=${scores[0]}&entry.993158810=${scores[1]}&entry.1924612937=${scores[2]}`;
    window.location.href = url;
  }
  
  // ローディング表示・非表示
  function showLoading() {
    document.getElementById("loading-overlay").style.display = "flex";
  }
  function hideLoading() {
    document.getElementById("loading-overlay").style.display = "none";
  }
//-------------------------------------------------------------------------




  function evaluateRoute(P, order) {
    const dest_num = order.length;
  
    let now_time = P.start_time;
    let feasible = true;
    let satisfaction_sum = 0.0;
    let move_time = 0.0;
    let waiting_time = 0.0;
  
    const ALPHA = 0.8;
    const BETA = 10;
  
    for (let idx = 1; idx < dest_num - 1; idx++) {
      const v = order[idx];
      const prev = order[idx - 1];
  
      // 移動時間加算
      now_time += P.cost[prev][v];
      move_time += P.cost[prev][v];
  
      const open_s = P.open_time[v][0];
      const open_e = P.open_time[v][1];
  
      // 営業開始前に到着 → 待機時間
      if (now_time < open_s) {
        waiting_time += (open_s - now_time);
        now_time = open_s;
      }
  
      // 必要滞在時間を加算
      now_time += P.required_time[v];
  
      if (now_time > open_e) feasible = false;
  
      // === 評価値計算 ===
      const cred = (P.review_num[v] * P.review_num[v]) /
                   (CONST_REVIEW_NUM * CONST_REVIEW_NUM);
  
      // match 計算
      let match = 0.0;
      const r = P.prefers.map(x => x / 3.0); // 長さ10
      for (let j = 0; j < 10; j++) {
        const p = P.view_points[v][j] / 3.0;
        match += Math.min(p, r[j]);
      }
      match /= 10.0;
  
      const S = P.review_val[v] *
                Math.min(1.0, cred) *
                Math.pow(match, 1.5);
  
      satisfaction_sum += S;
    }
  
    const move_ratio = move_time / (P.goal_time - P.start_time);
  
    const arrival_goal_time = now_time + P.cost[order[dest_num - 2]][order[dest_num - 1]];
  
    let early_ratio = 0.0;
  
    if (arrival_goal_time > P.goal_time) {
      feasible = false;
    } else {
      early_ratio = Math.pow(
        (P.goal_time - arrival_goal_time + waiting_time) /
        (P.goal_time - P.start_time),
        2
      );
    }
  
    let raw_score = satisfaction_sum - ALPHA * move_ratio - BETA * early_ratio;
  
    if (!feasible) raw_score -= 1000.0;
  
    return {
      score: raw_score,
      feasible: feasible,
      arrival_time_at_goal: arrival_goal_time
    };
  }
  
  function greedyInitial(P) {
    const route = [P.start_vertex];
    const used = Array(P.N).fill(false);
    used[P.start_vertex] = true;
    used[P.goal_vertex] = true;
  
    let now_time = P.start_time;
  
    // ランダムシャッフル用
    const shuffleArray = arr => {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    };
  
    // 候補地点リスト作成
    const candidates = [];
    for (let i = 0; i < P.N; i++) {
      if (!used[i]) candidates.push(i);
    }
    shuffleArray(candidates);
  
    const max_visits = Math.floor(P.N / 4); // 半分だけランダム訪問
  
    for (let cnt = 0; cnt < max_visits && candidates.length > 0; cnt++) {
      const v = candidates.pop();
  
      let arrival = now_time + P.cost[route[route.length - 1]][v];
      if (arrival < P.open_time[v][0]) arrival = P.open_time[v][0];
      const leave = arrival + P.required_time[v];
  
      if (leave > P.open_time[v][1]) continue;
      if (leave + P.cost[v][P.goal_vertex] > P.goal_time) continue;
  
      route.push(v);
      used[v] = true;
      now_time = leave;
    }
  
    route.push(P.goal_vertex);
    return route;
  }
  
  // ---------- neighbor 操作 ----------
  function neighborRandomSwap(route) {
    const n = route.length;
    if (n <= 3) return [...route];
    const r = [...route];
    let i = randInt(1, n - 2);
    let j = randInt(1, n - 2);
    if (i !== j) [r[i], r[j]] = [r[j], r[i]];
    return r;
  }
  
  function neighborRemove(route) {
    const n = route.length;
    if (n <= 6) return [...route];
    const r = [...route];
    // ★ 1番〜(n-2)番目しか削除しない（最後の0は消さない）
    const k = randInt(1, n - 2);
    r.splice(k, 1);
    return r;
  }
  
  function neighborInsert(route, P) {
    const n = route.length;
    if (n <= 3) return [...route];
    const r = [...route];
    const inRoute = Array(P.N).fill(false);
    route.forEach(v => inRoute[v] = true);
    const unused = [];
    for (let i = 0; i < P.N; i++) if (!inRoute[i]) unused.push(i);
    if (unused.length === 0) return r;
    const pick = unused[randInt(0, unused.length - 1)];
    const ip = randInt(1, r.length - 1);
    r.splice(ip, 0, pick);
    return r;
  }
  
  function neighborRelocate(route) {
    const n = route.length;
    if (n <= 3) return [...route];
    const r = [...route];
    let i = randInt(1, n - 2);
    let j = randInt(1, n - 2);
    while (i === j) j = randInt(1, n - 2);
    const v = r[i];
    r.splice(i, 1);
    if (i < j) j--;
    r.splice(j, 0, v);
    return r;
  }
  
  function neighbor2Opt(route) {
    const n = route.length;
    const r = [...route];
    let i = randInt(1, n - 2);
    let j = randInt(1, n - 2);
    while (i === j) j = randInt(1, n - 2);
    if (i > j) [i, j] = [j, i];
    while (i < j) {
      [r[i], r[j]] = [r[j], r[i]];
      i++;
      j--;
    }
    return r;
  }
  
  function twoOptLocalSearch(P, order) {
    const n = order.length;
    let r = [...order];
    let improved = true;
    let curEval = evaluateRoute(P, r);
  
    while (improved) {
      improved = false;
      let bestGain = 0.0;
      let bestI = -1, bestJ = -1;
  
      for (let i = 0; i < n - 2; i++) {
        for (let j = i + 2; j < n - 1; j++) {
          if (i === 0 && j === n - 1) continue;
          const cand = [...r];
          cand.splice(i + 1, j - i, ...cand.slice(i + 1, j + 1).reverse());
          const ev = evaluateRoute(P, cand);
          const gain = ev.score - curEval.score;
          if (gain > bestGain) {
            bestGain = gain;
            bestI = i;
            bestJ = j;
          }
        }
      }
  
      if (bestGain > 1e-12) {
        r.splice(bestI + 1, bestJ - bestI, ...r.slice(bestI + 1, bestJ + 1).reverse());
        curEval = evaluateRoute(P, r);
        improved = true;
      }
    }
  
    return r;
  }
  
  // ---------- annealing 操作 ----------
  async function simulatedAnnealing(P, time_limit_seconds) {
    let cur = greedyInitial(P);
    let curEval = evaluateRoute(P, cur);
  
    let best = [...cur];
    let bestEval = {...curEval};
  
    const start = performance.now(); // ミリ秒
    const limit_ns = time_limit_seconds * 1e3;
  
    let T0 = 50.0;
    let decay = 0.99;
    let T = T0;
    let stall_count = 0;
  
    let iter = 0;
  
    while (true) {
      iter++;
      
      // 非同期で描画の機会を与える
      if(iter%10000 === 0) await new Promise(r => setTimeout(r, 0));
  
      const now = performance.now();
      const elapsed = now - start;
  
      if (elapsed >= limit_ns) break;
  
      const mv = randInt(0, 99);
      let cand;
  
      if (elapsed < time_limit_seconds * 0.4 * 1e3) {
        //console.log(iter, "debug1");
        if (mv < 20) cand = neighborRandomSwap(cur);
        else if (mv < 40) cand = neighborRemove(cur);
        else if (mv < 60) cand = neighborInsert(cur, P);
        else if (mv < 80) cand = neighborRelocate(cur);
        else cand = neighbor2Opt(cur);
        if(iter%3000 == 0) cand = twoOptLocalSearch(P, cand);
      } else if (elapsed < time_limit_seconds * 0.8 * 1e3) {
        if (mv < 15) cand = neighborRandomSwap(cur);
        else if (mv < 25) cand = neighborRemove(cur);
        else if (mv < 40) cand = neighborInsert(cur, P);
        else if (mv < 70) cand = neighborRelocate(cur);
        else cand = neighbor2Opt(cur);
        if(iter%800 == 0) cand = twoOptLocalSearch(P, cand);
      } else {
        if (mv < 60) cand = neighborRelocate(cur);
        else cand = neighbor2Opt(cur);
        if(iter%200 == 0) cand = twoOptLocalSearch(P, cand);
      }
  
      const candEval = evaluateRoute(P, cand);
      const delta = candEval.score - curEval.score;
      let accept = false;
  
      if (delta >= 0) accept = true;
      else if (Math.random() < Math.exp(delta / T)) accept = true;
  
      if (accept) {
        cur = [...cand];
        curEval = {...candEval};
        if (curEval.score > bestEval.score) {
          best = [...cur];
          bestEval = {...curEval};
          stall_count = 0;
        } else stall_count++;
      } else {
        stall_count++;
      }
  
      if (stall_count > 50) {
        T = T0;
        stall_count = 0;
      } else {
        T *= decay;
      }
    }
  
    return best;
  }
  
  // ルート計算
  function computeRoute() {
    const repeat_num = 36;
    const time_limit = 7.0; // 秒
    const unit = time_limit / repeat_num;
    
    if(trialIndex === 1){
      P.start_vertex = 2; // 富岩運河
      P.goal_vertex = 2;
    }
    else if(trialIndex === 2){
      P.start_vertex = 61; // 高岡駅
      P.goal_vertex = 61;
    }
    else if(trialIndex === 3){
      P.start_vertex = 19; // 富山駅
      P.goal_vertex = 19;
    }
    
    return new Promise(async resolve => {
      let best = [];
      let evalResult = null;
    
      for (let i = 0; i < repeat_num; i++) {
        const cand = await simulatedAnnealing(P, unit);
        const candEval = evaluateRoute(P, cand);
    
        if (i === 0) {
          evalResult = candEval;
          best = [...cand];
        }
        if (candEval.score > evalResult.score) {
          evalResult = candEval;
          best = [...cand];
        }
      }
  
      resolve(best);
    });
  }
</script>

<!-- ローディングオーバーレイ -->
<div id="loading-overlay">
  <img src="https://raw.githubusercontent.com/Romilli/Romilli.github.io/main/loading.gif" 
       width="640" height="640">
</div>


</body>
</html>
